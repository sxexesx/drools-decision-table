# Использование Decision Table в JBoss Drools

Правила. Мы узнаем это слово с самого детства. В начале родители говорят нам, как нужно поступать, а как лучше не стоит.
Потом мы приходим в школу, и там учителя диктуют свои порядки. В университете мы опять же сталкиваемся с правилами,
которые для нас устанавливают преподаватели и деканат. Взрослеем и начинаем уже следовать законам, которые разработаны
государством. Что общего у всех этих правил? То, что они выверены годами, десятилетиями, а некоторые даже и поколениями.
Представьте какова была бы наша жизнь, если бы правила менялись часто: каждую неделю или каждый день!

У нас в компании Mediascope в ежедневной поставке данных мы тоже используем правила: для рассчета демографических атрибутов
респондентов и домохозяйств, для расчета характеристик категорий товаров или брендов. Все эти правила меняются достаточно
часто, и каждый раз переделывать конвеер поставки данных было бы накладно. Поэтому мы решили вынести эти правила отдельно
от кода и отдать их на поддержку бизнесу. В данной статье я хотел бы показать, как мы пользуемся этими правилами, а также
продемонстрировать основные конструкции и практики использования правил.

### Что это вообще такое?

Довольно часто в процессе разработки коммерческого софта мы сталкиваемся с проблемой, когда некоторую логику расчета 
необходимо передать на сторону заказчика. Зачастую представитель этого заказчика не хочет (или не может) использовать 
какой-либо язык программирования для описания необходимой логики работы приложения. В таких случаях на помощь приходят
BRMS или Business Rule Management System. Это такая информационная система для создания, управления и исполнения той самой
бизнес-логики приложения. Её еще называют бизнес-правилами. Обычно такие системы состоят из сервера, на котором происходит
выполнение правил - это юрисдикция программистов, и средств ведения самих правил - это уже зона ответственности бизнеса.
 
Практически каждая компания, где бизнес плотно взаимодействует с программной разработкой, пытается изобрести свой 
"велосипед". И мы не исключение. После первой итерации разработки системы управления правилами, было принято решение 
отказаться от внутреннего решения в пользу уже существующих. Причин было несколько: недостаточно быстрая работа системы, 
неудобное описание правил, постоянно возникающие ошибки расчета, и что самое страшное, непредсказуемо меняющийся 
выходной результат. Хорошо, что мы не внедрили это решение в продакшен! 

BRMS фреймворков на рынке достаточно много. Свои решения предлагают многие крупные компании: IBM, Red Hat, Agiloft, SAS
и даже Bosch. Все они либо платные, либо не подходили нам по тем или иным критериям. Решили начать с уже зарекомендовавшей
себя системы JBoss Drools. Она достаточно надежная, проверенная временем, используется в банковских решениях,
ритейле и телекоме, а также предоставляет возможность ведения бизнес-правил, как на специальном языке DRL, так и с
помощью Excel-таблиц. Существует также и несколько UI решений для ведения правил. Так как наши аналитики используют
единую систему ведения справочников и нам удобнее хранить правила там, поэтому от использования UI мы отказались в пользу
понятных бизнесу Excel-таблиц.

### Что же такое бизнес-правило и как оно выглядит?

Обычно бизнес-правило - это набор инструкций или ограничений, которые позволяют принимать решение о вы полнении того или
иного действия. Другими словами это некий набор логики, который позволяет в зависимости от вариации входных значений
выполнять определенные действия, соответствующие входным параметрам. Давайте разберем простой пример.

У нас есть респондент, который обладает характеристикой _Гендерная идентичность (gender)_. В зависимости от значения этой
характеристики респонденту выставляет _Пол_ (SEX). То есть, если gender = male, то значению свойства пол нужно будет
поставить _1_. В противном случае это будет _2_. На языке DRL это правило будет выглядеть следующим образом:

> rule "Rule 1 Example 1"
>  	when
>  		$s: Respondent($s.gender == "male")
>  	then
>  		$s.addResult("SEX", "1");
>  end
>
> rule "Rule 2 Example 2"
>  	when
>  		$s: Respondent($s.gender == "female")
>  	then
>  		$s.addResult("SEX", "2");
>  end


5. Описание общих структур Decision table

6. Примеры использования и сочетания:
* доступ к полю объекта (String, Integer, Boolean)
* пример с диапазоном
* работа с коллекциями
    * contains +++
    * forall(||) и forall (&&). Пример использования с Map +++
    * size для List/Map +++
* вложенный объект ++
* List<SomeClass> где SomeClass состоит из свойства и List'а +
* modify


